name = "gruff"
main = "src/index.ts"
compatibility_date = "2024-01-01"

# D1 Database binding (local development uses automatic local DB)
[[d1_databases]]
binding = "DB"
database_name = "gruff-db"
database_id = "local-db" # For local dev, Wrangler creates this automatically
migrations_dir = "migrations"

# KV namespace for caching and sessions (local development uses automatic local KV)
[[kv_namespaces]]
binding = "KV"
id = "local-kv"

# Analytics Engine for error tracking and metrics
# Note: In local development, Analytics Engine is simulated
# For production, create via: wrangler analytics-engine create gruff-errors
[[analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "gruff_errors"

[vars]
# Environment variables (non-secret)
ENVIRONMENT = "development"
# JWT secret for local development only
# For production, use: wrangler secret put JWT_SECRET
JWT_SECRET = "dev-secret-key-change-in-production-use-wrangler-secret-put"
# Allowed origins for CORS (comma-separated for production)
# In development, all origins are allowed
# For production, set to your frontend domains: ALLOWED_ORIGINS = "https://app.example.com,https://admin.example.com"
# ALLOWED_ORIGINS = "https://app.example.com"

# Google OAuth2 Configuration
# For local development, these are placeholder values
# For production, use: wrangler secret put GOOGLE_CLIENT_SECRET
# Get credentials from: https://console.cloud.google.com/apis/credentials
GOOGLE_CLIENT_ID = "your-google-client-id.apps.googleusercontent.com"
GOOGLE_REDIRECT_URI = "http://localhost:8787/api/auth/google/callback"

# =============================================================================
# Environment: Preview (Pull Request deployments)
# =============================================================================
# Note: For CI/CD to work, you need to:
# 1. Create a D1 database for preview: wrangler d1 create gruff-db-preview
# 2. Create a KV namespace for preview: wrangler kv:namespace create KV_PREVIEW
# 3. Update the IDs below with the actual values
# 4. Set secrets: wrangler secret put JWT_SECRET --env preview

[env.preview]
name = "gruff-preview"

[env.preview.vars]
ENVIRONMENT = "preview"
# Google OAuth2 - Set GOOGLE_CLIENT_SECRET via: wrangler secret put GOOGLE_CLIENT_SECRET --env preview
GOOGLE_CLIENT_ID = "your-google-client-id.apps.googleusercontent.com"
GOOGLE_REDIRECT_URI = "https://gruff-preview.your-domain.workers.dev/api/auth/google/callback"

[[env.preview.d1_databases]]
binding = "DB"
database_name = "gruff-db-preview"
database_id = "REPLACE_WITH_PREVIEW_DATABASE_ID"
migrations_dir = "migrations"

[[env.preview.kv_namespaces]]
binding = "KV"
id = "REPLACE_WITH_PREVIEW_KV_NAMESPACE_ID"

[[env.preview.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "gruff_errors_preview"

# =============================================================================
# Environment: Production
# =============================================================================
# Note: For production deployment, you need to:
# 1. Create a D1 database: wrangler d1 create gruff-db
# 2. Create a KV namespace: wrangler kv:namespace create KV
# 3. Update the IDs below with the actual values
# 4. Set secrets: wrangler secret put JWT_SECRET
# 5. Optionally set: wrangler secret put ALLOWED_ORIGINS

[env.production]
name = "gruff"

[env.production.vars]
ENVIRONMENT = "production"
# Google OAuth2 - Set GOOGLE_CLIENT_SECRET via: wrangler secret put GOOGLE_CLIENT_SECRET --env production
GOOGLE_CLIENT_ID = "your-google-client-id.apps.googleusercontent.com"
GOOGLE_REDIRECT_URI = "https://gruff.your-domain.workers.dev/api/auth/google/callback"

[[env.production.d1_databases]]
binding = "DB"
database_name = "gruff-db"
database_id = "REPLACE_WITH_PRODUCTION_DATABASE_ID"
migrations_dir = "migrations"

[[env.production.kv_namespaces]]
binding = "KV"
id = "REPLACE_WITH_PRODUCTION_KV_NAMESPACE_ID"

[[env.production.analytics_engine_datasets]]
binding = "ANALYTICS"
dataset = "gruff_errors"
